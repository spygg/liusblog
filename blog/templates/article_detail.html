{% extends 'base.html' %}

{% load static %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="/static/css/article_detail.css">
{% endblock %}

{% block js %}
    <script type="text/javascript" src="/static/js/artiledetail.js"></script>
    <script type="text/javascript" src="{% static "ckeditor/ckeditor-init.js" %}"></script>
    <script type="text/javascript" src="{% static "ckeditor/ckeditor/ckeditor.js" %}"></script>


{% endblock %}


{% block left_area%}
  <!-- 面包屑导航 -->
  <div class="nav-path">
    <ol class="breadcrumb breadcrumb-artile-path">
        <li class="breadcrumb-item">
          <a href="/">Home</a>
        </li>
        <li class="breadcrumb-item">
          <a href="{% url 'article_list' %}?blog_type={{ article.blog_type }}">{{ article.blog_type }}</a>
        </li>
        <li class="breadcrumb-item" class="active"> {{ article.title }}</li>
    </ol>
  </div>

  <!-- 某一篇文章 -->
  <div class="well article-area  article-area-article clearfix">

    <div class="article-info">
      <div class="article-title">
          <h1>
            {{ article.title }}
          </h1>
      </div>
    </div>
    <div class="article-status">
      <span>{{ article.created_time|date:"Y-m-d, G:i" }}</span>
      <span>阅读 {{ article.read_number }} </span>

      <span>
          <a href="#" target="#" title="查看文章评论">评论 7</a>
      </span>
      <span class="pull-right">
        <a class = "modify_article" href="#" title="修改文章">
          修改
        </a>
      </span>
    </div>
    <div class="artile-detail">
        {{ article.content|safe}}
    </div>

    {# 版权区域 #}
    <div class="copyright hidden-xs">
      <p class="copyright-p"><span class="copyright-strong">本文标题:</span>{{ article.title }}</p>
      <p class="copyright-p"><span class="copyright-strong">文章作者:</span>{{ article.author}}</p>
      <p class="copyright-p"><span class="copyright-strong">发布时间:</span>{{ article.created_time|date:"Y-m-d, G:i:s" }}</p>
      <p class="copyright-p"><span class="copyright-strong">最后更新:</span>{{ article.last_modify_time|date:"Y-m-d, G:i:s" }}</p>
      <p class="copyright-p"><span class="copyright-strong">原始链接:</span> <a href="">{{ url }}</a></p>
    </div>

    <!-- 打赏 -->
    <div class="sponsor">
      <div class="sponsor-title">
        <p>小礼物走一走，期待您的打赏哦 !</p>
      </div>
      <div class="btn btn-danger sponsor-btn" data-target="#loginModal" data-toggle="modal">
        <i class="fa fa-jpy" aria-hidden="true"></i>
        <span>打赏</span>
      </div>
    </div>

    <!-- modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog"  aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                </button>
                <div class="modal-title">
                  <span>
                    求包养
                  </span>
                  <img src="/static/imgs/sponsor/mistressesme.gif">
                </div>

              </div>

              <div class="modal-body sponsor-qr-code clearfix">
                <div class="col-xs-6">
                  <img src="/static/imgs/sponsor/weixincode.jpg" alt="">
                  <p>微信赞助</p>
                </div>
                <div class="col-xs-6">
                  <img src="/static/imgs/sponsor/zhifubaocode.jpg" alt="">
                  <p>支付宝打赏</p>
                </div>
              </div>

              <div class="modal-footer">
                您的支持是我前行的动力!
              </div>
            </div>
        </div>
    </div>


    <!-- 打赏结束 -->
  </div><!-- 某一篇文章结束 -->
  
  {# 上下篇 #}
  <div class="article-nav">
    <span class='pre-article'>
      {% if prev_article.title %}
        <a href="{% url 'article_detail' %}?id={{ prev_article.id }}&blog_type={{ blog_type }}">← {{ prev_article.title }} </a>
      {% endif %}
    </span>

    <span class='next-article'>
      {% if next_article.title %}
        {% if blog_type == 'all' %}
          <a href="#">{{ next_article.title }} →</a>
        
        {% else%}
          <a href="{% url 'article_detail' %}?id={{ next_article.id }}&blog_type={{ blog_type }}">{{ next_article.title }} →</a>
        {% endif %}
      {% endif %}
    </span>
  </div>

  <div class="well comment-area clearfix">
    <div class="comment-commit-area">
      {% if user.is_authenticated %}
        
        <div class="login-status clearfix">
           <form id="comment_form" method="POST" action="">
            {% csrf_token %} 
            <strong>
              {{ user.username }}
            </strong>欢迎评论~
            {% for field in commentForm %}
              {{ field }}
              <p class="text-danger">
                {{ field.errors.as_text }}
              </p>
            {% endfor %}
             <span id='comment_error' class="text-danger pull-left">
                {{ loginForm.non_field_errors }} 
            </span> 

            <input type="submit" class='btn btn-primary pull-right' value="发表" />
          </form>
        </div>
       
      {% else %}
        <div class="unlogin-status">
           <span>
            您尚未登录, 请
          </span>
          <a href="{% url 'login' %}?from={{ request.get_full_path }}">登录</a>
          <span>或</span>
          <a href="{% url 'register' %}}?from={{ request.get_full_path }}">注册</a>
          <span>后评论~</span>

          <div class="login-link mt-2">
            <a class="mx-3" href="{% url 'thridpaty_login' 'weibo' %}?from={{ request.get_full_path }}" title="社交账号登录有点慢，请耐心等候！"><i
                    class="fa fa-weibo fa-2x"></i></a>
            <a class="mx-3" href="{% url 'thridpaty_login' 'gitbhub' %}?from={{ request.get_full_path }}" title="社交账号登录有点慢，请耐心等候！"><i
                    class="fa fa-github fa-2x"></i></a>
          </div>
        </div>
      {% endif %}
    </div>

    <div class="comment-list-area">
      {% if comments%}  
        <div class="comment-tips">
          2 人参与 | 2 条评论
        </div>
      {% endif %}
      
      <div id='comment_list' class="comment-list">
        {% for comment in comments%}
          <div  class='comment'>
             {{ comment.user.username }} 
             ({{ comment.created_time|date:"Y-m-d, G:i:s" }})
             {{ comment.content|safe }}
          </div>
        {% empty %}
          暂无评论,赶紧抢沙发~~~~
        {% endfor %}
      </div> 
    </div>
  </div>

  
{% endblock %}

{% block right_area%}
   <div class="hidden-xs  col-sm-4 col-md-3 toc-area">
      <ul class="toc-level1">
      </ul>
  </div>
  <!-- 右边区域结束 --> 
{% endblock %}



{% block scriptextends %}
  <script type="text/javascript">
    $("#comment_form").submit(function(){
      //更新数据
      CKEDITOR.instances['id_content'].updateElement();
      
      //异步提交
      $.ajax({
        url: "{% url 'comment' %}",
        type: 'POST',
        data: $(this).serialize(),
        cache: false,
        success: function(data){
          if (data['status'] == 'SUCCESS'){
            console.log(data)
            var coment_html = '<div> '+ data['username'] + ' ('+ data['created_time'] +'): '+ data['content'] +' </div>';

            $("#comment_list").prepend(coment_html);
            CKEDITOR.instances['id_content'].setData('');
            $('#comment_error').text('');
          }
          else{
            $('#comment_error').text(data['message']);
          }

          
          
        },
        error: function(xhr){
          console.log(xhr);
        }
      });
      return false;
    });
  </script>
{% endblock %}